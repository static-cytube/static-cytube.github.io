/*!
 **|  CyTube PM Enhancements
 **|  Copyright Xaekai 2014-16
 **|  Copyright Cinema-Blue 2024
 **|  Version 2023.11.18.1900
 **@preserve
 */ "use strict";var CyTube_BetterPM;(CyTube_BetterPM=function(e,t,a,n){if("undefined"==typeof Storage){console.error("[Better PMs]","localStorage not supported. Aborting load.");return}if(void 0===CLIENT.name){console.error("[Better PMs]","Client is an anonymous user. Aborting load.");return}console.info("[Better PMs]","Loading Module."),e[CHANNEL.name]||(e[CHANNEL.name]={}),e.initPm=function(t){if(a("#pm-"+t).length>0)return a("#pm-"+t);var n,r=a("<div/>").addClass("panel panel-default pm-panel").appendTo(a("#pmbar")).data("last",{name:""}).attr("id","pm-"+t),s=a("<div/>").addClass("panel-heading").text(t).appendTo(r);a("<button/>").addClass("close pull-right").html("&times;").appendTo(s).click(function(){r.remove(),a("#pm-placeholder-"+t).remove()});var i=a("<div/>").addClass("panel-body").appendTo(r).hide();s.click(function(){if(i.toggle(),r.removeClass("panel-primary").addClass("panel-default"),i.is(":hidden"))r.css("position",""),a("#pm-placeholder-"+t).remove();else{n=a("<div/>").addClass("pm-panel-placeholder").attr("id","pm-placeholder-"+t).insertAfter(r);var e=r.position().left;r.css("position","absolute").css("bottom","0px").css("left",e)}}),a("<div/>").addClass("pm-buffer linewrap").appendTo(i),a("<hr/>").appendTo(i);var o=a("<input/>").addClass("form-control pm-input").attr("type","text").attr("maxlength",240).appendTo(i);return o.keydown(function(a){if(13===a.keyCode){if(!CHATTHROTTLE){var n={},r=o.val();""!==r.trim()&&(USEROPTS.modhat&&CLIENT.rank>=Rank.Moderator&&(n.modflair=CLIENT.rank),e.CLIENT.rank>=Rank.Moderator&&0===r.indexOf("/m ")&&(n.modflair=CLIENT.rank,r=r.substring(3)),socket.emit("pm",{to:t,msg:r,meta:n}),o.val(""))}}}),a("#pmbar").trigger("deployCache",t),({startCheck:function(e){if(a("#pm-"+e).length){var t=initPm(e).find(".pm-buffer");t.children().last().length&&t.children().last()[0].scrollIntoView(),t[0].scrollTop=t[0].scrollHeight,(t[0].scrollHeight!=this.scrollHeight||0===this.scrollHeight)&&(this.scrollHeight=t[0].scrollHeight,setTimeout(this.startCheck.bind(this),this.timeout,e))}},scrollHeight:-1,timeout:250}).startCheck(t),r},e.Callbacks.pm=function(e,t){var n=e.username;if(-1===IGNORED.indexOf(n)){e.username===CLIENT.name?n=e.to:pingMessage(!0);var r=initPm(n),s=formatChatMessage(e,r.data("last")),i=r.find(".pm-buffer");if(s.appendTo(i),i.scrollTop(i.prop("scrollHeight")),r.find(".panel-body").is(":hidden")&&r.removeClass("panel-default").addClass("panel-primary"),!t){var o=CLIENT.name!==e.username?e.username:e.to;a("#pmbar").trigger("newMessage",[o,e])}}},CLIENT.BetterPMs||(CLIENT.BetterPMs=(new class t{constructor(){return null===localStorage.getItem(`${CHANNEL.name}_BetterPM_PrevOpen_${CLIENT.name}`)&&localStorage.setItem(`${CHANNEL.name}_BetterPM_PrevOpen_${CLIENT.name}`,JSON.stringify([])),this.previouslyOpen=JSON.parse(localStorage.getItem(`${CHANNEL.name}_BetterPM_PrevOpen_${CLIENT.name}`)),this.openCache={},a("#pmbar").on("deployCache",(e,t)=>{this.deployCache(t),this.saveOpen()}),a("#pmbar").on("newMessage",(e,t,a)=>{this.newMessage(t,a),this.saveOpen()}),a(e).on("unload.openprivs",()=>{this.saveOpen(),this.flushCache()}),this}flushCache(){Object.keys(this.openCache).forEach(e=>{localStorage.setItem(`${CHANNEL.name}_BetterPM_History_${CLIENT.name}_${e}`,JSON.stringify(this.openCache[e]))})}deployCache(e){null!==localStorage.getItem(`${CHANNEL.name}_BetterPM_History_${CLIENT.name}_${e}`)&&(this.initCache(e),this.openCache[e].slice(this.openCache[e].length>50?this.openCache[e].length-50:0).forEach(e=>{Callbacks.pm(e,!0)}))}scheduleFlush(){this.flushCache()}initCache(e){void 0===this.openCache[e]&&(this.openCache[e]=JSON.parse(localStorage.getItem(`${CHANNEL.name}_BetterPM_History_${CLIENT.name}_${e}`)))}saveOpen(){var e=[];a("#pmbar > div[id^=pm]:not(.pm-panel-placeholder)").each(function(){e.push(a(this).attr("id").replace(/^pm-/,""))}),localStorage.setItem(`${CHANNEL.name}_BetterPM_PrevOpen_${CLIENT.name}`,JSON.stringify(e))}newMessage(e,t){null===localStorage.getItem(`${CHANNEL.name}_BetterPM_History_${CLIENT.name}_${e}`)&&localStorage.setItem(`${CHANNEL.name}_BetterPM_History_${CLIENT.name}_${e}`,JSON.stringify([])),this.initCache(e),this.openCache[e].push(t),this.scheduleFlush()}startUp(){return a("#pmbar > div[id^=pm]:not(.pm-panel-placeholder)").each(function(){}),this.previouslyOpen.forEach(e=>{initPm(e)}),localStorage.setItem(`${CHANNEL.name}_BetterPM_PrevOpen_${CLIENT.name}`,JSON.stringify([])),this}}).startUp())})(window,document,window.jQuery);