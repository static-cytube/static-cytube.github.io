/*!  CyTube Enhancements: Common
**|  Version: 2024.09.21
**@preserve
*/ "use strict";jQuery("head").append('<meta name="referrer" content="no-referrer" />'),jQuery("<link>").appendTo("head").attr({id:"font-awesome",type:"text/css",rel:"stylesheet",href:"https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"});const messageExpireTime=12e4,chatExpireTime=72e5,previewTime=3e5,Rooms_Base=CBE.Root_URL+"rooms/",Rules_URL=Rooms_Base+"cytube-rules.html",Rooms_URL=Rooms_Base+"cytube-rooms.html",Footer_URL=CBE.Base_URL+"footer.html",Logo_URL=CBE.Room_URL+"logo.png",Favicon_URL=CBE.Room_URL+"favicon.png",PREFIX_RELOAD="\x9c",PREFIX_IGNORE="\x9d",PREFIX_INFO="\x9e",PREFIX_MUTE="\x9f";var GUEST_WARN=!1;const GUEST_WARNING='NOTICE: You are in Preview mode. You must&nbsp; <a href="https://cytu.be/register">REGISTER</a> &nbsp;to chat or PM in this room.';if(CBE.$chatline=jQuery("#chatline"),CBE.$messagebuffer=jQuery("#messagebuffer"),CBE.$userlist=jQuery("#userlist"),CBE.$userListItems=jQuery("#userlist .userlist_item"),CBE._originalCallbacks={},CBE._originalEmit=null,CBE._originalRemoveVideo=null,CBE._notifyPing=null,CBE._msgPing=null,CBE._store=!1,CBE.LAST_PM="","undefined"!=typeof Storage){let e="store";try{localStorage.setItem(e,e),localStorage.removeItem(e),CBE._store=!0}catch{}}async function notifyMe(e,t,n){if(CBE.debugData("common.notifyMe",arguments),document.hasFocus()){CBE.msgPing();return}if(!("Notification"in window))return;if("denied"===Notification.permission){CBE.debugData("common.notifyMe.permission",Notification.permission);return}if("granted"!==Notification.permission&&await Notification.requestPermission(),CBE.debugData("common.notifyMe.permission",Notification.permission),"granted"!==Notification.permission)return;CBE.notifyPing();let o=new Notification(e+": "+t,{body:n,tag:e,lang:"en-US",icon:"https://static.cinema-blue.icu/img/favicon.png",silent:!1});document.addEventListener("visibilitychange",function(e){try{CBE.debugData("common.notifyMe.visibilitychange",e),o.close()}catch{}},{once:!0}),o.onclick=function(){CBE.debugData("common.notifyMe.onclick"),window.parent.focus(),o.close()},setTimeout(function(){o.close()},2e4)}CBE.Sleep=function(e){return new Promise(function(t){setTimeout(t,e)})},CBE.timeString=function(e){e instanceof Date||(e=new Date(e));let t=new Date,n=new Intl.DateTimeFormat("default",{month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1}).format(e).split(/[\s,]+/),o=n[1];return e.toDateString()!==t.toDateString()&&(o=n[0]+" "+o),"["+o+"]"},CBE.formatConsoleMsg=function(e,t=null){let n=e;return void 0!==t&&t&&("function"==typeof t?n+=": "+t.toString():n+=": "+JSON.stringify(t,null,2)),"["+new Date().toTimeString().split(" ")[0]+"] "+n},CBE.traceLog=function(e,t=null){window.console.log(CBE.formatConsoleMsg(e)),CHANNEL_DEBUG&&void 0!==t&&t&&window.console.debug(JSON.stringify(t,null,2))},CBE.debugData=function(e,t=null){CHANNEL_DEBUG&&window.console.debug(CBE.formatConsoleMsg(e,t))},CBE.warnData=function(e,t=null){window.console.warn(CBE.formatConsoleMsg(e,t))},CBE.errorData=function(e,t=null){window.console.error(CBE.formatConsoleMsg(e,t))},CBE.logData=function(e,t=null){window.console.log(CBE.formatConsoleMsg(e,t))},CBE.debugListener=function(e,t){"mediaupdate"!==e.toLowerCase()&&window.console.info(CBE.formatConsoleMsg(e,t))},CBE.hmsToSeconds=function(e){let t=e.split(":"),n=0,o=1;for(;t.length>0;)n+=o*parseInt(t.pop(),10),o*=60;return n},CBE.secondsToHMS=function(e){let t=15;return e>=36e3?t=11:e>=3600?t=12:e>=600&&(t=14),new Date(1e3*e).toISOString().substring(t,19)},CBE.whisper=function(e){addChatMessage({msg:e,time:Date.now(),username:"[server]",msgclass:"server-whisper",meta:{shadow:!1,addClass:"server-whisper",addClassToNameAndTimestamp:!0}})},CBE.fChat=function(e){addChatMessage({msg:e,time:Date.now(),username:CLIENT.name,meta:{}})},CBE.fPM=function(e,t){t=window.formatChatMessage({username:CLIENT.name,msg:t,meta:{},time:Date.now(),to:e},{name:""});let n=window.initPm(e).find(".pm-buffer");t.appendTo(n)},CBE.waitForElement=function(e,t,n,o){let a=Date.now();!function i(){if(jQuery(e).length){t();return}setTimeout(function(){!(o&&Date.now()-a>o)&&i()},n)}()},CBE.notifyPing=function(){if("granted"===Notification.permission)try{CBE._notifyPing&&CBE._notifyPing.play()}catch{}},CBE.msgPing=function(){if("granted"===Notification.permission)try{CBE._msgPing&&CBE._msgPing.play()}catch{}},CBE.getUser=function(e){let t=null;return CBE.$userListItems.each(function(n,o){let a=jQuery(o).data();if(Object.keys(a).length<6)return null;a.name.toLowerCase()===e.toLowerCase()&&(t=a)}),t},CBE.isUserHere=function(e){return null!==CBE.getUser(e)},CBE.isUserAFK=function(e){let t=!1,n=CBE.getUser(e);return!!n&&n.meta.afk},CBE.roomAnnounce=function(e){!(e.length<1)&&!(window.CLIENT.rank<window.Rank.Member)&&BOT_NICK.toLowerCase()!==CLIENT.name.toLowerCase()&&jQuery(function(){makeAlert("Message from Admin",e).attr("id","roomAnnounce").appendTo("#announcements")})},CBE.modAnnounce=function(e){!(e.length<1)&&!(window.CLIENT.rank<window.Rank.Moderator)&&BOT_NICK.toLowerCase()!==CLIENT.name.toLowerCase()&&jQuery(function(){makeAlert("Moderators",e).attr("id","modAnnounce").appendTo("#announcements")})},CBE.hideVideoURLs=function(){setTimeout(function(){jQuery(".qe_title").each(function(e,t){let n=jQuery(this);n.is("a")&&n.replaceWith('<span class="qe_title" href="'+n.attr("href")+'">'+n.text()+"</span>")}),jQuery("#queue li.queue_entry").removeAttr("title"),window.CLIENT.rank>Rank.Member&&jQuery("#queue li.queue_entry div.btn-group").hide()},2e3)},window.CLIENT.rank<Rank.Moderator&&(window.socket.on("changeMedia",CBE.hideVideoURLs()),window.socket.on("playlist",CBE.hideVideoURLs()),window.socket.on("setPlaylistMeta",CBE.hideVideoURLs()),window.socket.on("shufflePlaylist",CBE.hideVideoURLs())),CBE.VideoInfo={title:"None",current:0,duration:0},CBE.setVideoTitle=function(){CBE.VideoInfo.duration<1&&(CBE.VideoInfo.duration=CBE.VideoInfo.current);let e=Math.round(CBE.VideoInfo.duration-CBE.VideoInfo.current);jQuery("#currenttitle").html("Playing: <strong>"+CBE.VideoInfo.title+"</strong> &nbsp; ("+CBE.secondsToHMS(e)+")")},CBE.refreshVideo=function(){CBE.debugData("common.refreshVideo",window.CurrentMedia),window.PLAYER?(PLAYER.mediaType="",PLAYER.mediaId=""):window.CurrentMedia&&window.loadMediaPlayer(window.CurrentMedia),window.socket.emit("playerReady")},CBE.videoFix=function(){CBE.debugData("common.videoFix");let e=videojs("ytapiplayer");e.on("error",function(t){CBE.errorData("common.Reloading Player",t),e.createModal("ERROR: Reloading player!"),window.setTimeout(function(){CBE.refreshVideo()},2e3)})},CBE.videoErrorHandler=function(e){CBE.errorData("common.videoErrorHandler",e),CBE.refreshVideo()},CBE.overrideMediaRefresh=function(){jQuery(document).off("click","#mediarefresh").on("click","#mediarefresh",function(){window.USEROPTS.sync_accuracy<20&&(window.USEROPTS.synch=!0,window.USEROPTS.sync_accuracy+=2,storeOpts(),applyOpts()),CBE.refreshVideo()})},CBE.pmAfkOff=function(e){CBE.isUserAFK(CLIENT.name)&&window.socket.emit("chatMsg",{msg:"/afk"})},window.CLIENT.rank<window.Rank.Admin&&window.socket.on("pm",CBE.hideVideoURLs),CBE.pmAllUsers=function(e){jQuery("#userlist .userlist_item").each(function(t,n){let o=jQuery(n).data();o.name!==window.CLIENT.name&&window.socket.emit("pm",{to:o.name,msg:e,meta:{}})})},CBE.autoMsgExpire=function(){CBE.$messagebuffer.find("[class^=chat-msg-\\\\\\$]:not([data-expire])").each(function(){jQuery(this).attr("data-expire",Date.now()+12e4)}),CBE.$messagebuffer.find("[class^=server-msg]:not([data-expire])").each(function(){jQuery(this).attr("data-expire",Date.now()+12e4)}),CBE.$messagebuffer.find("div.poll-notify:not([data-expire])").attr("data-expire",Date.now()+24e4),window.CLIENT.rank<window.Rank.Moderator&&(CBE.$messagebuffer.find("[class*=chat-shadow]:not([data-expire])").each(function(){jQuery(this).attr("data-expire",Date.now()+12e4)}),CBE.$messagebuffer.find("[class*=chat-msg-]:not([data-expire])").each(function(){jQuery(this).attr("data-expire",Date.now()+72e5)})),CBE.$messagebuffer.find("div[data-expire]").each(function(){Date.now()>parseInt(jQuery(this).attr("data-expire"))&&jQuery(this).remove()}),"hidden"===document.visibilityState&&CBE.$messagebuffer.find("div[data-expire]").each(function(){jQuery(this).attr("data-expire",parseInt(jQuery(this).attr("data-expire"))+400)})},CBE.fixUserlist=function(){CBE.$userlist.find(".userlist_owner:not([data-content])").each(function(){jQuery(this).attr("data-content",jQuery(this).text())}),CBE.$userlist.find(".userlist_op:not([data-content])").each(function(){jQuery(this).attr("data-content",jQuery(this).text())})},CBE.cacheEmotes=function(){for(let e=0;e<CHANNEL.emotes.length;e++){let t=document.createElement("img");t.src=CHANNEL.emotes[e].image,t.onerror=function(){window.console.error("Error loading '"+this.src+"'")}}try{CBE._notifyPing=new Audio("https://cdn.freesound.org/previews/25/25879_37876-lq.mp3"),CBE._msgPing=new Audio("https://cdn.freesound.org/previews/662/662411_11523868-lq.mp3")}catch{}},CBE.getFooter=function(){jQuery.ajax({url:Footer_URL,type:"GET",datatype:"text",cache:!1,error:function(e){CBE.errorData("common.getFooter Error",e.status+": "+e.statusText)},success:function(e){CBE.debugData("common.getFooter",e),jQuery("p.credit").html(e)}})},CBE.CustomCallbacks={changeMedia:function(e){CBE.debugData("CustomCallbacks.changeMedia",e),CBE._originalCallbacks.changeMedia(e),window.CurrentMedia=e,CBE.VideoInfo.title=e.title,CBE.VideoInfo.current=e.currentTime,CBE.VideoInfo.duration=e.seconds,CBE.setVideoTitle(),CBE.waitForElement("#ytapiplayer",function(){let e=document.getElementById("ytapiplayer");e&&e.addEventListener("error",CBE.hideVideoURLs,!0)},100,1e4),GUEST_WARN&&(GUEST_WARN=!1,setTimeout(function(){CBE.whisper(GUEST_WARNING)},2e4),setTimeout(function(){window.location.replace("/register")},3e5))},chatMsg:function(e){CBE.debugData("CustomCallbacks.chatMsg",e),!("[server]"===e.username&&e.msg.includes("cleared chat"))&&(e.username!==window.CLIENT.name&&"["!==e.username[0]&&CBE.msgPing(),CBE._originalCallbacks.chatMsg(e))},disconnect:function(e){CBE.debugData("CustomCallbacks.disconnect",e),window.KICKED&&removeVideo(),CBE._originalCallbacks.disconnect(e)},mediaUpdate:function(e){if(CBE._originalCallbacks.mediaUpdate(e),window.PLAYER&&window.PLAYER.player&&window.PLAYER.player.error_){CBE.refreshVideo();return}CBE.VideoInfo.current=e.currentTime,CBE.setVideoTitle()},pm:function(e){if(CBE.debugData("CustomCallbacks.pm",e),!(window.CLIENT.name.toLowerCase()===BOT_NICK.toLowerCase()||e.to.toLowerCase()===BOT_NICK.toLowerCase()||"Z"===window.xyz||e.msg.startsWith("\x9e"))){if(e.msg.startsWith("\x9f")){jQuery(".chat-msg-"+e.msg.slice(1)).each(function(){jQuery(this).remove()});return}if(e.username!==window.CLIENT.name){if(e.msg.startsWith("\x9c")){location.reload(!0);return}notifyMe(window.CHANNELNAME,e.username,e.msg)}CBE._originalCallbacks.pm(e)}},addUser:function(e){CBE.debugData("CustomCallbacks.addUser",e),CBE._originalCallbacks.addUser(e),jQuery("#pm-"+e.name).attr("id","#pm-"+e.name),jQuery("#pm-"+e.name+" .panel-heading").removeClass("pm-gone"),setTimeout(function(){CBE.fixUserlist()},200),BOT_NICK.toLowerCase()!==CLIENT.name.toLowerCase()&&setTimeout(function(){jQuery(".userlist_owner:contains('"+BOT_NICK+"')").parent().css("display","none")},6e3)},userLeave:function(e){CBE.debugData("CustomCallbacks.userLeave",e),jQuery("#pm-"+e.name+" .panel-heading").addClass("pm-gone"),CBE._originalCallbacks.userLeave(e)},channelCSSJS:function(e){CBE.debugData("CustomCallbacks.channelCSSJS",e),CBE._originalCallbacks.channelCSSJS(e),jQuery("#chancss").remove()},setUserMeta:function(e){CBE.debugData("CustomCallbacks.setUserMeta",e),CBE._originalCallbacks.setUserMeta(e),e.meta.muted&&CBE.pmAllUsers("\x9f"+e.name)}},CBE.initCallbacks=function(e){for(let t in CBE.CustomCallbacks)CBE.CustomCallbacks.hasOwnProperty(t)&&(CBE.debugData("common.initCallbacks.key",t),CBE._originalCallbacks[t]=window.Callbacks[t],window.Callbacks[t]=CBE.CustomCallbacks[t])},CBE.overrideEmit=function(){!CBE._originalEmit&&window.socket.emit&&(CBE._originalEmit=window.socket.emit,window.socket.emit=function(){let e=Array.prototype.slice.call(arguments);if(e[0],"chatMsg"===e[0]||"pm"===e[0]){if(!GUESTS_CHAT&&window.CLIENT.rank<window.Rank.Member){CBE.whisper(GUEST_WARNING);return}if("Z"===window.xyz){"chatMsg"===e[0]&&CBE.fChat(e[1].msg),"pm"===e[0]&&CBE.fPM(e[1].to,e[1].msg);return}let t=e[1].msg.trim();t.match(/^[{Letter}]/i)&&!t.startsWith("http")&&(t=t[0].toLocaleUpperCase()+t.slice(1),e[1].msg=t),"pm"===e[0]&&(CBE.LAST_PM=e[1].msg)}CBE._originalEmit.apply(window.socket,e)})},CBE.overrideRemoveVideo=function(){return!CBE._originalRemoveVideo&&!!window.removeVideo&&(CBE._originalRemoveVideo=window.removeVideo,window.removeVideo=function(e){let t=Array.prototype.slice.call(arguments);CBE._originalRemoveVideo.apply(window.removeVideo,t),jQuery("#drinkbarwrap").after('<div id="videotitle"><span id="currenttitle"></span></div>'),CBE.setVideoTitle()},!0)},CBE.setMOTDmessage=function(){null!==MOTD_MSG&&!(MOTD_MSG.length<1)&&jQuery("#motd div:last").append(MOTD_MSG)},CBE.customUserOpts=function(){window.USEROPTS.first_visit=!1,window.USEROPTS.ignore_channelcss=!1,window.USEROPTS.ignore_channeljs=!1,window.USEROPTS.modhat=!0,window.USEROPTS.synch=!0,window.USEROPTS.sync_accuracy=6,window.CLIENT.rank>=window.Rank.Moderator&&(window.USEROPTS.show_shadowchat=!0,window.USEROPTS.show_ip_in_tooltip=!0,window.USEROPTS.show_timestamps=!0,window.USEROPTS.blink_title="onlyping"),storeOpts(),applyOpts()},CBE.showRules=function(){jQuery("#cytube_rules").modal()},CBE.showRooms=function(){jQuery("#cytube_x").load(Rooms_Base+"cytube_x.html"),jQuery("#cytube_k").load(Rooms_Base+"cytube_k.html"),jQuery("#cytube_pg").load(Rooms_Base+"cytube_pg.html"),jQuery("#cytube_nn").load(Rooms_Base+"cytube_nn.html"),jQuery("#cytube_to").load(Rooms_Base+"cytube_to.html"),jQuery("#otherlists").load(Rooms_Base+"otherlists.html"),jQuery("#cytube_rooms").on("click",function(){jQuery(this).modal("hide")}).modal("show")},jQuery(document).ready(function(){if(CBE.initCallbacks(),CBE.customUserOpts(),CBE.getFooter(),window.CLIENT.rank<window.Rank.Moderator&&CBE.hideVideoURLs(),MOTD_RULES&&(jQuery.get(Rules_URL,function(e){jQuery("#pmbar").before(e),CBE.debugData("common.ready.Rules",e)}),jQuery("#nav-collapsible > ul").append('<li><a id="showrules" href="javascript:void(0)" onclick="javascript:CBE.showRules()">Rules</a></li>')),MOTD_ROOMS&&(jQuery.get(Rooms_URL,function(e){jQuery("#pmbar").before(e)}),jQuery("#nav-collapsible > ul").append('<li><a id="showrooms" href="javascript:void(0)" onclick="javascript:CBE.showRooms()">Rooms</a></li>')),window.CLIENT.rank<window.Rank.Member&&jQuery("#nav-collapsible > ul").append('<li><a id="showregister" class="throb_text" target="_blank" href="/register">Register</a></li>'),jQuery("#plonotification").remove(),jQuery("#plmeta").insertBefore("#queue"),jQuery(`<link id="roomfavicon" href="${Favicon_URL}?v=${START}" type="image/x-icon" rel="shortcut icon" />`).appendTo("head"),null!==ROOM_ANNOUNCEMENT&&CBE.roomAnnounce(ROOM_ANNOUNCEMENT),null!==MOD_ANNOUNCEMENT&&CBE.modAnnounce(MOD_ANNOUNCEMENT),setTimeout(function(){jQuery("#announcements").fadeOut(800,function(){jQuery(this).remove()})},9e4),ADVERTISEMENT&&window.CLIENT.rank<window.Rank.Moderator&&jQuery("#pollwrap").after(`<div id="adwrap" class="col-lg-12 col-md-12">${ADVERTISEMENT}</div>`),jQuery(window).on("focus",function(){CBE.$chatline.focus()}),window.setInterval(function(){CBE.autoMsgExpire(),CBE.$chatline.attr("spellcheck","true").attr("autocapitalize","sentences").css({"background-image":"none"}),jQuery(".pm-input").attr("spellcheck","true").attr("autocapitalize","sentences").css({"background-image":"none"})},1e3),window.setInterval(function(){CBE.fixUserlist()},5e3),jQuery("body").keypress(function(e){!jQuery(e.target).is(":input, [contenteditable]")&&CBE.$chatline.focus()}),window.CLIENT.rank>window.Rank.Moderator?CBE.$chatline.attr("placeholder","Type here to Chat"):CBE.$chatline.attr("placeholder",CLIENT.name),CBE.$chatline.focus(),window.CLIENT.rank>window.Rank.Guest){let e=jQuery("#modflair");e.hasClass("label-default")&&e.trigger("click")}window.CLIENT.rank>window.Rank.Moderator&&(socket.on("errorMsg",function(e){e.msg.startsWith("PM failed:")&&navigator.clipboard.writeText(CBE.LAST_PM)}),0===jQuery("#leader").length&&jQuery('<button class="btn btn-sm btn-default" id="leader">Leader</button>').appendTo("#plcontrol").on("click",function(){CLIENT.leader=!CLIENT.leader,CLIENT.leader?jQuery(this).removeClass("btn-default").addClass("btn-warning"):jQuery(this).removeClass("btn-warning").addClass("btn-default")}),0===jQuery("#clear").length&&jQuery('<button class="btn btn-sm btn-default" id="clear" title="Clear Chat"><i class="fa-solid fa-scissors">&nbsp;</i>Clear</button>').appendTo("#leftcontrols").on("click",function(){window.confirm("Clear Chat?")&&(window.socket.emit("chatMsg",{msg:"/clear",meta:{}}),window.socket.emit("playerReady"))})),window.CLIENT.rank>=window.Rank.Moderator&&(0===jQuery("#clean").length&&jQuery('<button class="btn btn-sm btn-default" id="clean" title="Clean Server Messages"><i class="fa-solid fa-broom">&nbsp;</i>CleanUp</button>').appendTo("#leftcontrols").on("click",function(){CBE.$messagebuffer.find("[class^=server-whisper]").each(function(){jQuery(this).parent().remove()}),CBE.$messagebuffer.find("[class^=poll-notify]").each(function(){jQuery(this).remove()}),CBE.$messagebuffer.find("[class^=chat-msg-\\\\\\$server]").each(function(){jQuery(this).remove()}),CBE.$messagebuffer.find("[class^=server-msg]").each(function(){jQuery(this).remove()}),CBE.$messagebuffer.find("[class^=chat-shadow]").each(function(){jQuery(this).remove()}),jQuery(".chat-msg-Video:not(:last)").each(function(){jQuery(this).remove()}),jQuery(".chat-msg-"+BOT_NICK).each(function(){jQuery(this).remove()})}),0===jQuery("#nextvid").length&&jQuery('<button class="btn btn-sm btn-default" id="nextvid" title="Force Skip"><i class="fa-solid fa-circle-right">&nbsp;</i>Skip</button>').appendTo("#leftcontrols").on("click",function(){window.socket.emit("playNext")})),!GUESTS_CHAT&&window.CLIENT.rank<window.Rank.Member&&(GUEST_WARN=!0,jQuery("#pmbar").remove()),CBE.overrideMediaRefresh(),CBE.refreshVideo(),CBE.cacheEmotes(),CBE.overrideRemoveVideo(),CBE.overrideEmit(),CBE.setMOTDmessage()});