/*!  CyTube Enhancements: Common
**|  Version: 2024.06.03
**@preserve
*/ "use strict";window[CHANNEL.name]||(window[CHANNEL.name]={}),$("head").append('<meta name="referrer" content="no-referrer" />');const messageExpireTime=12e4,chatExpireTime=72e5,previewTime=3e5,Rooms_Base=Root_URL+"rooms/",Rooms_URL=Rooms_Base+"cytube-rooms.html",Rules_URL=Rooms_Base+"cytube-rules.html",Footer_URL=Base_URL+"footer.html",Logo_URL=Room_URL+"logo.png",Favicon_URL=Room_URL+"favicon.png",PREFIX_RELOAD="\x9c",PREFIX_IGNORE="\x9d",PREFIX_INFO="\x9e";var $chatline=$("#chatline"),$currenttitle=$("#currenttitle"),$messagebuffer=$("#messagebuffer"),$userlist=$("#userlist"),$voteskip=$("#voteskip"),$ytapiplayer=$("#ytapiplayer"),$userListItems=$("#userlist .userlist_item"),$videoUrls=$(".qe_title"),_originalCallbacks={},_originalEmit=null,_notifyPing=null,_msgPing=null,GUEST_WARN=!1;const GUEST_WARNING='NOTICE: You are in Preview mode. You must&nbsp; <a href="https://cytu.be/register">REGISTER</a> &nbsp;to chat or PM in this room.';$("<link>").appendTo("head").attr({type:"text/css",rel:"stylesheet",href:"https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.css"});const isNullOrEmpty=function(e){return null==e||("string"==typeof e?e.length<1:!e)},notNullOrEmpty=function(e){return!isNullOrEmpty(e)};function Sleep(e){return new Promise(function(t){setTimeout(t,e)})}const timeString=function(e){e instanceof Date||(e=new Date(e));let t=new Date,n=new Intl.DateTimeFormat("default",{month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1}).format(e).split(/[\s,]+/),o=n[1];return e.toDateString()!==t.toDateString()&&(o=n[0]+" "+o),"["+o+"]"},formatConsoleMsg=function(e,t){let n=e;return void 0!==t&&t&&("function"==typeof t?n+=": "+t.toString():n+=": "+JSON.stringify(t,null,2)),"["+new Date().toTimeString().split(" ")[0]+"] "+n},logTrace=function(e,t){window.console.log(formatConsoleMsg(e)),CHANNEL_DEBUG&&void 0!==t&&t&&window.console.debug(JSON.stringify(t,null,2))},debugData=function(e,t){CHANNEL_DEBUG&&window.console.debug(formatConsoleMsg(e,t))},warnData=function(e,t){window.console.warn(formatConsoleMsg(e,t))},errorData=function(e,t){window.console.error(formatConsoleMsg(e,t))},logData=function(e,t){window.console.log(formatConsoleMsg(e,t))},debugListener=function(e,t){"mediaupdate"!==e.toLowerCase()&&window.console.info(formatConsoleMsg(e,t))},hmsToSeconds=function(e){let t=e.split(":"),n=0,o=1;for(;t.length>0;)n+=o*parseInt(t.pop(),10),o*=60;return n},secondsToHMS=function(e){let t=15;return e>=36e3?t=11:e>=3600?t=12:e>=600&&(t=14),new Date(1e3*e).toISOString().substring(t,19)},whisper=function(e){addChatMessage({msg:e,time:Date.now(),username:"[server]",msgclass:"server-whisper",meta:{shadow:!1,addClass:"server-whisper",addClassToNameAndTimestamp:!0}})},waitForElement=function(e,t,n,o){let a=Date.now();!function i(){if($(e).length){t();return}setTimeout(function(){!(o&&Date.now()-a>o)&&i()},n)}()},notifyPing=function(){if("granted"===Notification.permission)try{notNullOrEmpty(_notifyPing)&&_notifyPing.play()}catch{}},msgPing=function(){if("granted"===Notification.permission)try{notNullOrEmpty(_msgPing)&&_msgPing.play()}catch{}},getUser=function(e){let t=null;return $userListItems.each(function(n,o){let a=$(o).data();if(Object.keys(a).length<6)return null;a.name.toLowerCase()===e.toLowerCase()&&(t=a)}),t},isUserHere=function(e){return null!==getUser(e)},isUserAFK=function(e){let t=!1,n=getUser(e);return!!n&&n.meta.afk};async function notifyMe(e,t,n){if(debugData("common.notifyMe",arguments),document.hasFocus()){msgPing();return}if(!("Notification"in window))return;if("denied"===Notification.permission){debugData("common.notifyMe.permission",Notification.permission);return}if("granted"!==Notification.permission&&await Notification.requestPermission(),debugData("common.notifyMe.permission",Notification.permission),"granted"!==Notification.permission)return;notifyPing();let o=new Notification(e+": "+t,{body:n,tag:e,lang:"en-US",icon:"https://static.cinema-blue.icu/img/favicon.png",silent:!1});document.addEventListener("visibilitychange",function(e){try{debugData("common.notifyMe.visibilitychange",e),o.close()}catch{}},{once:!0}),o.onclick=function(){debugData("common.notifyMe.onclick"),window.parent.focus(),o.close()},setTimeout(function(){o.close()},2e4)}const roomAnnounce=function(e){!(e.length<1)&&!(window.CLIENT.rank<window.Rank.Member)&&BOT_NICK.toLowerCase()!==CLIENT.name.toLowerCase()&&$(function(){makeAlert("Message from Admin",e).attr("id","roomAnnounce").appendTo("#announcements")})},modAnnounce=function(e){!(e.length<1)&&!(window.CLIENT.rank<window.Rank.Moderator)&&BOT_NICK.toLowerCase()!==CLIENT.name.toLowerCase()&&$(function(){makeAlert("Moderators",e).attr("id","modAnnounce").appendTo("#announcements")})},hideVideoURLs=function(){setTimeout(function(){jQuery(".qe_title").each(function(e,t){let n=jQuery(this);n.is("a")&&n.replaceWith('<span class="qe_title" href="'+n.attr("href")+'">'+n.text()+"</span>")}),jQuery("#queue li.queue_entry").removeAttr("title"),window.CLIENT.rank>Rank.Member&&jQuery("#queue li.queue_entry div.btn-group").hide()},2e3)};window.CLIENT.rank<Rank.Moderator&&(window.socket.on("changeMedia",hideVideoURLs()),window.socket.on("playlist",hideVideoURLs()),window.socket.on("setPlaylistMeta",hideVideoURLs()),window.socket.on("shufflePlaylist",hideVideoURLs())),window[CHANNEL.name].VideoInfo={title:"None",current:0,duration:0};var VIDEO_TITLE={title:"None",current:0,duration:0};const setVideoTitle=function(){VIDEO_TITLE.duration<1&&(VIDEO_TITLE.duration=VIDEO_TITLE.current);let e=Math.round(VIDEO_TITLE.duration-VIDEO_TITLE.current);$currenttitle.html("Playing: <strong>"+VIDEO_TITLE.title+"</strong> &nbsp; ("+secondsToHMS(e)+")")},refreshVideo=function(){debugData("common.refreshVideo",window.CurrentMedia),window.PLAYER?(PLAYER.mediaType="",PLAYER.mediaId=""):notNullOrEmpty(window.CurrentMedia)&&window.loadMediaPlayer(window.CurrentMedia),window.socket.emit("playerReady")},videoFix=function(){debugData("common.videoFix");let e=videojs("ytapiplayer");e.on("error",function(t){errorData("common.Reloading Player",t),e.createModal("ERROR: Reloading player!"),window.setTimeout(function(){refreshVideo()},2e3)})};function videoErrorHandler(e){errorData("common.videoErrorHandler",e),refreshVideo()}const overrideMediaRefresh=function(){$(document).off("click","#mediarefresh").on("click","#mediarefresh",function(){window.USEROPTS.sync_accuracy<20&&(window.USEROPTS.synch=!0,window.USEROPTS.sync_accuracy+=2,storeOpts(),applyOpts()),refreshVideo()})},pmAfkOff=function(e){isUserAFK(CLIENT.name)&&window.socket.emit("chatMsg",{msg:"/afk"})};window.CLIENT.rank<window.Rank.Admin&&window.socket.on("pm",pmAfkOff);const autoMsgExpire=function(){$messagebuffer.find("[class^=chat-msg-\\\\\\$]:not([data-expire])").each(function(){$(this).attr("data-expire",Date.now()+12e4)}),$messagebuffer.find("[class^=server-msg]:not([data-expire])").each(function(){$(this).attr("data-expire",Date.now()+12e4)}),$messagebuffer.find("div.poll-notify:not([data-expire])").attr("data-expire",Date.now()+24e4),window.CLIENT.rank<window.Rank.Moderator&&($messagebuffer.find("[class*=chat-shadow]:not([data-expire])").each(function(){$(this).attr("data-expire",Date.now()+12e4)}),$messagebuffer.find("[class*=chat-msg-]:not([data-expire])").each(function(){$(this).attr("data-expire",Date.now()+72e5)})),$messagebuffer.find("div[data-expire]").each(function(){Date.now()>parseInt($(this).attr("data-expire"))&&$(this).remove()}),"hidden"===document.visibilityState&&$messagebuffer.find("div[data-expire]").each(function(){$(this).attr("data-expire",parseInt($(this).attr("data-expire"))+400)})},fixUserlist=function(){$userlist.find(".userlist_owner:not([data-content])").each(function(){$(this).attr("data-content",$(this).text())}),$userlist.find(".userlist_op:not([data-content])").each(function(){$(this).attr("data-content",$(this).text())})},cacheEmotes=function(){for(let e=0;e<CHANNEL.emotes.length;e++){let t=document.createElement("img");t.src=CHANNEL.emotes[e].image,t.onerror=function(){window.console.error("Error loading '"+this.src+"'")}}try{_notifyPing=new Audio("https://cdn.freesound.org/previews/25/25879_37876-lq.mp3"),_msgPing=new Audio("https://cdn.freesound.org/previews/662/662411_11523868-lq.mp3")}catch{}},getFooter=function(){$.ajax({url:Footer_URL,type:"GET",datatype:"text",cache:!1,error:function(e){errorData("common.getFooter Error",e.status+": "+e.statusText)},success:function(e){debugData("common.getFooter",e),$("p.credit").html(e)}})},makeNoRefererMeta=function(){let e=document.createElement("meta");e.name="referrer",e.content="no-referrer",document.head.append(e)};$("head").append('<meta name="referrer" content="no-referrer" />');const CustomCallbacks={changeMedia:function(e){debugData("CustomCallbacks.changeMedia",e),_originalCallbacks.changeMedia(e),window.CurrentMedia=e,VIDEO_TITLE.title=e.title,VIDEO_TITLE.current=e.currentTime,VIDEO_TITLE.duration=e.seconds,setVideoTitle(),waitForElement("#ytapiplayer",function(){let e=document.getElementById("ytapiplayer");e&&e.addEventListener("error",videoErrorHandler,!0)},100,1e4),GUEST_WARN&&(GUEST_WARN=!1,setTimeout(function(){whisper(GUEST_WARNING)},2e4),setTimeout(function(){window.location.replace("/register")},3e5))},chatMsg:function(e){debugData("CustomCallbacks.chatMsg",e),"["!==e.username[0]&&e.username!==window.CLIENT.name&&msgPing(),_originalCallbacks.chatMsg(e)},disconnect:function(e){window.KICKED&&removeVideo(event),_originalCallbacks.disconnect(e)},mediaUpdate:function(e){if(_originalCallbacks.mediaUpdate(e),window.PLAYER&&window.PLAYER.player&&window.PLAYER.player.error_){refreshVideo();return}VIDEO_TITLE.current=e.currentTime,setVideoTitle()},pm:function(e){if(debugData("CustomCallbacks.pm",e),!(window.CLIENT.name.toLowerCase()===BOT_NICK.toLowerCase()||e.to.toLowerCase()===BOT_NICK.toLowerCase()||e.msg.startsWith("\x9e"))){if(e.username.toLowerCase()!==window.CLIENT.name.toLowerCase()&&notifyMe(window.CHANNELNAME,e.username,e.msg),e.msg.startsWith("\x9c")){location.reload(!0);return}_originalCallbacks.pm(e)}},addUser:function(e){debugData("CustomCallbacks.addUser",e),_originalCallbacks.addUser(e),$("#pm-"+e.name).attr("id","#pm-"+e.name),$("#pm-"+e.name+" .panel-heading").removeClass("pm-gone"),setTimeout(function(){fixUserlist()},500),BOT_NICK.toLowerCase()!==CLIENT.name.toLowerCase()&&setTimeout(function(){$(".userlist_owner:contains('"+BOT_NICK+"')").parent().css("display","none")},6e3)},userLeave:function(e){$("#pm-"+e.name+" .panel-heading").addClass("pm-gone"),_originalCallbacks.userLeave(e)}},initCallbacks=function(e){for(let t in CustomCallbacks)CustomCallbacks.hasOwnProperty(t)&&(debugData("common.initCallbacks.key",t),_originalCallbacks[t]=window.Callbacks[t],window.Callbacks[t]=CustomCallbacks[t])},overrideEmit=function(){isNullOrEmpty(_originalEmit)&&notNullOrEmpty(window.socket.emit)&&(_originalEmit=window.socket.emit,window.socket.emit=function(){let e=Array.prototype.slice.call(arguments);if("chatMsg"===e[0]||"pm"===e[0]){if(!GUESTS_CHAT&&window.CLIENT.rank<window.Rank.Member){whisper(GUEST_WARNING);return}let t=e[1].msg.trim();"/"===t[0]||t.startsWith("http")||(t=t[0].toLocaleUpperCase()+t.slice(1),e[1].msg=t),navigator.clipboard.writeText(t)}_originalEmit.apply(window.socket,e)})},setMOTDmessage=function(){null!==MOTD_MSG&&!(MOTD_MSG.length<1)&&$("#motd div:last").append(MOTD_MSG)},customUserOpts=function(){window.USEROPTS.first_visit=!1,window.USEROPTS.ignore_channelcss=!1,window.USEROPTS.ignore_channeljs=!1,window.USEROPTS.modhat=!0,window.USEROPTS.synch=!0,window.USEROPTS.sync_accuracy=6,window.CLIENT.rank>=window.Rank.Moderator&&(window.USEROPTS.show_shadowchat=!0,window.USEROPTS.show_ip_in_tooltip=!0,window.USEROPTS.show_timestamps=!0,window.USEROPTS.blink_title="onlyping"),storeOpts(),applyOpts()},showRules=function(){$("#cytube_rules").modal()},showRooms=function(){$("#cytube_x").load(Rooms_Base+"cytube_x.html"),$("#cytube_k").load(Rooms_Base+"cytube_k.html"),$("#cytube_pg").load(Rooms_Base+"cytube_pg.html"),$("#cytube_nn").load(Rooms_Base+"cytube_nn.html"),$("#cytube_to").load(Rooms_Base+"cytube_to.html"),$("#otherlists").load(Rooms_Base+"otherlists.html"),$("#cytube_rooms").on("click",function(){$(this).modal("hide")}).modal("show")};$(document).ready(function(){if(customUserOpts(),initCallbacks(),getFooter(),window.CLIENT.rank<window.Rank.Moderator&&hideVideoURLs(),MOTD_RULES&&($.get(Rules_URL,function(e){$("#pmbar").before(e),debugData("common.ready.Rules",e)}),$("#nav-collapsible > ul").append('<li><a id="showrules" href="javascript:void(0)" onclick="javascript:showRules()">Rules</a></li>')),MOTD_ROOMS&&($.get(Rooms_URL,function(e){$("#pmbar").before(e)}),$("#nav-collapsible > ul").append('<li><a id="showrooms" href="javascript:void(0)" onclick="javascript:showRooms()">Rooms</a></li>')),window.CLIENT.rank<window.Rank.Member&&$("#nav-collapsible > ul").append('<li><a id="showregister" class="throb_text" target="_blank" href="/register">Register</a></li>'),$("#plonotification").remove(),$("#plmeta").insertBefore("#queue"),$('<link id="roomfavicon" href="'+Favicon_URL+"?ac="+START+'" type="image/x-icon" rel="shortcut icon" />').appendTo("head"),null!==ROOM_ANNOUNCEMENT&&roomAnnounce(ROOM_ANNOUNCEMENT),null!==MOD_ANNOUNCEMENT&&modAnnounce(MOD_ANNOUNCEMENT),setTimeout(function(){$("#announcements").fadeOut(800,function(){$(this).remove()})},9e4),notNullOrEmpty(ADVERTISEMENT)&&window.CLIENT.rank<window.Rank.Moderator&&$("#pollwrap").after('<div id="adwrap" class="col-lg-12 col-md-12">'+ADVERTISEMENT+"</div>"),$(window).on("focus",function(){$("#chatline").focus()}),window.setInterval(function(){autoMsgExpire(),$("#chatline").attr("spellcheck","true").css({"background-image":"none"}),$(".pm-input").attr("spellcheck","true").css({"background-image":"none"})},1e3),window.setInterval(function(){fixUserlist()},5e3),$("body").keypress(function(e){!$(e.target).is(":input, [contenteditable]")&&$("#chatline").focus()}),$("#chatline").attr("placeholder","Type here to Chat").focus(),window.CLIENT.rank>window.Rank.Guest){let e=$("#modflair");e.hasClass("label-default")&&e.trigger("click")}window.CLIENT.rank>window.Rank.Moderator&&0===$("#clear").length&&$('<button class="btn btn-sm btn-default" id="clear" title="Clear Chat"><i class="fa-solid fa-scissors">&nbsp;</i>Clear</button>').appendTo("#leftcontrols").on("click",function(){window.socket.emit("chatMsg",{msg:"/clear",meta:{}}),window.socket.emit("playerReady")}),window.CLIENT.rank>=window.Rank.Moderator&&(0===$("#clean").length&&$('<button class="btn btn-sm btn-default" id="clean" title="Clean Server Messages"><i class="fa-solid fa-broom">&nbsp;</i>CleanUp</button>').appendTo("#leftcontrols").on("click",function(){let e=$("#messagebuffer");e.find("[class^=server-whisper]").each(function(){$(this).parent().remove()}),e.find("[class^=poll-notify]").each(function(){$(this).remove()}),e.find("[class^=chat-msg-\\\\\\$server]").each(function(){$(this).remove()}),e.find("[class^=server-msg]").each(function(){$(this).remove()}),$(".chat-msg-Video:not(:last)").each(function(){$(this).remove()}),$(".chat-msg-"+BOT_NICK).each(function(){$(this).remove()})}),0===$("#nextvid").length&&$('<button class="btn btn-sm btn-default" id="nextvid" title="Force Skip"><i class="fa-solid fa-circle-right">&nbsp;</i>Skip</button>').appendTo("#leftcontrols").on("click",function(){window.socket.emit("playNext")})),!GUESTS_CHAT&&window.CLIENT.rank<window.Rank.Member&&(GUEST_WARN=!0,$("#pmbar").remove()),overrideMediaRefresh(),refreshVideo(),cacheEmotes(),overrideEmit(),setMOTDmessage()});