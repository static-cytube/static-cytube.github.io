/*!  CyTube PM Enhancements
**|  Version 2024.05.31
**|  Copyright Xaekai 2014-16
**|  Copyright Cinema-Blue 2024
**@preserve
*/ "use strict";var CyTube_BetterPM;(CyTube_BetterPM=function(e,t,a,s){if("undefined"==typeof Storage){console.error("[Better PMs]","localStorage not supported. Aborting load.");return}if(void 0===e.CLIENT.name){console.error("[Better PMs]","Client is an anonymous user. Aborting load.");return}console.info("[Better PMs]","Loading Module."),e.initPm=function(t){if(a("#pm-"+t).length>0)return a("#pm-"+t);var s,r=a("<div/>").addClass("panel panel-default pm-panel").appendTo(a("#pmbar")).data("last",{name:""}).attr("id","pm-"+t),i=a("<div/>").addClass("panel-heading").text(t).appendTo(r);a("<button/>").addClass("close pull-right").html("&times;").appendTo(i).click(function(){r.remove(),a("#pm-placeholder-"+t).remove()});var n=a("<div/>").addClass("panel-body").appendTo(r).hide();i.click(function(){if(n.toggle(),r.removeClass("panel-primary").addClass("panel-default"),n.is(":hidden"))r.css("position",""),a("#pm-placeholder-"+t).remove();else{s=a("<div/>").addClass("pm-panel-placeholder").attr("id","pm-placeholder-"+t).insertAfter(r);var e=r.position().left;r.css("position","absolute").css("bottom","0px").css("left",e)}}),a("<div/>").addClass("pm-buffer linewrap").appendTo(n),a("<hr/>").appendTo(n);var l=a("<input/>").addClass("form-control pm-input").attr("type","text").attr("maxlength",240).appendTo(n);return l.keydown(function(a){if(13===a.keyCode){if(!e.CHATTHROTTLE){var s={},r=l.val();""!==r.trim()&&(e.USEROPTS.modhat&&e.CLIENT.rank>=e.Rank.Moderator&&(s.modflair=e.CLIENT.rank),e.CLIENT.rank>=e.Rank.Moderator&&0===r.indexOf("/m ")&&(s.modflair=e.CLIENT.rank,r=r.substring(3)),e.socket.emit("pm",{to:t,msg:r,meta:s}),l.val(""))}}}),a("#pmbar").trigger("deployCache",t),({startCheck:function(t){if(a("#pm-"+t).length){var s=e.initPm(t).find(".pm-buffer");s.children().last().length&&s.children().last()[0].scrollIntoView(),s[0].scrollTop=s[0].scrollHeight,(s[0].scrollHeight!==this.scrollHeight||0===this.scrollHeight)&&(this.scrollHeight=s[0].scrollHeight,setTimeout(this.startCheck.bind(this),this.timeout,t))}},scrollHeight:-1,timeout:250}).startCheck(t),r},e.Callbacks.pm=function(t,s){var r=t.username;if(-1===e.IGNORED.indexOf(r)){t.username===e.CLIENT.name?r=t.to:e.pingMessage(!0);var i=e.initPm(r),n=e.formatChatMessage(t,i.data("last")),l=i.find(".pm-buffer");if(n.appendTo(l),l.scrollTop(l.prop("scrollHeight")),i.find(".panel-body").is(":hidden")&&i.removeClass("panel-default").addClass("panel-primary"),!s){var o=e.CLIENT.name!==t.username?t.username:t.to;a("#pmbar").trigger("newMessage",[o,t,])}}},e.CLIENT.BetterPMs||(e.CLIENT.BetterPMs=new class t{static get maxPMs(){return 50}static get maxMS(){return 6048e5}constructor(){return this.cleanStorage(),null===e.localStorage.getItem(this.keyPrev())&&e.localStorage.setItem(this.keyPrev(),JSON.stringify([])),this.prevOpen=JSON.parse(e.localStorage.getItem(this.keyPrev())),this.cacheObj={},a("#pmbar").on("deployCache",(e,t)=>{this.deployCache(t),this.saveOpen()}),a("#pmbar").on("newMessage",(e,t,a)=>{this.newMessage(t,a),this.saveOpen()}),a(e).on("unload.openprivs",()=>{this.saveOpen(),this.flushCache()}),this}keyPrev(){return`bpmPrev_${e.CHANNEL.name}_${e.CLIENT.name}`}keyHistory(t){return`bpmHist_${e.CHANNEL.name}_${e.CLIENT.name}_${t}`}cleanStorage(){}flushCache(){Object.keys(this.cacheObj).forEach(t=>{e.localStorage.setItem(this.keyHistory(t),JSON.stringify(this.cacheObj[t]))})}initCache(t){void 0===this.cacheObj[t]&&(this.cacheObj[t]=JSON.parse(e.localStorage.getItem(this.keyHistory(t))))}deployCache(t){null!==e.localStorage.getItem(this.keyHistory(t))&&(this.initCache(t),this.cacheObj[t].slice(this.cacheObj[t].length>this.maxPMs?this.cacheObj[t].length-this.maxPMs:0).forEach(t=>{e.Callbacks.pm(t,!0)}))}saveOpen(){var t=[];a("#pmbar > div[id^=pm]:not(.pm-panel-placeholder)").each(function(){t.push(a(this).attr("id").replace(/^pm-/,""))}),e.localStorage.setItem(this.keyPrev(),JSON.stringify(t))}newMessage(t,a){null===e.localStorage.getItem(this.keyHistory(t))&&e.localStorage.setItem(this.keyHistory(t),JSON.stringify([])),this.initCache(t),this.cacheObj[t].push(a),this.flushCache()}startUp(){return a("#pmbar > div[id^=pm]:not(.pm-panel-placeholder)").each(function(){}),this.prevOpen.forEach(t=>{e.initPm(t)}),e.localStorage.setItem(this.keyPrev(),JSON.stringify([])),this}}().startUp())})(window,document,window.jQuery);